# How to Use Sponsorship Policy Webhooks

Webhooks allow you to receive real-time notifications about sponsorship-related events. You can use them to approve or reject sponsorship requests and get updates on finalized sponsorships.

To set up a webhook:
1. Go to the [Sponsorship Policies page](https://dashboard.pimlico.io/sponsorship-policies) in the Pimlico dashboard.
2. Click on an existing policy.
3. Click the "Edit" button to configure webhooks.

## Webhook Types

### UserOperation Sponsorship
These webhooks are triggered when using the [`pm_sponsorUserOperation`](/infra/paymaster/erc20-paymaster/endpoints/pm_sponsorUserOperation) endpoint.

#### Request for Sponsorship
:::warning[Deprecation Notice]
The webhook type `sponsorshipPolicy.webhook` will be replaced with `user_operation.sponsorship.requested` on **March 1st, 2024**.
:::

Webhook payload example:
```typescript
const body = {
    type: "user_operation.sponsorship.requested",
    data: {
        object: {
            userOperation,
            entryPoint,
            chainId,
            sponsorshipPolicyId,
            apiKey
        }
    }
}
```

Response format:
```json
{
    "sponsor": true // Boolean - whether to approve the sponsorship
}
```

#### Sponsorship Finalized
Sent when a UserOperation sponsorship is approved and finalized.

Webhook payload example:
```typescript
const body = {
    type: "user_operation.sponsorship.finalized",
    data: {
        object: {
            userOperation,
            entryPoint,
            chainId,
            sponsorshipPolicyId,
            apiKey
        }
    }
}
```

### MagicSpend Withdrawal
These webhooks are triggered when using the [`pimlico_sponsorMagicSpendWithdrawal`](/infra/magic-spend/endpoints/pimlico_sponsorMagicSpendWithdrawal) endpoint.

#### Request for Withdrawal
Sent when a MagicSpend withdrawal sponsorship is requested.

Webhook payload example:
```typescript
const body = {
    type: "magic_spend.sponsorship.requested",
    data: {
        object: {
            recipient,
            token,
            amount,
            signature,
            chainId,
            apiKey,
            sponsorshipPolicyId
        }
    }
}
```

Response format:
```json
{
    "sponsor": true // Boolean - whether to approve the withdrawal
}
```

#### Withdrawal Finalized
Sent when a MagicSpend withdrawal is approved and finalized.

Webhook payload example:
```typescript
const body = {
    type: "magic_spend.sponsorship.finalized",
    data: {
        object: {
            withdrawal,
            hash,
            signature,
            chainId,
            apiKey,
            sponsorshipPolicyId
        }
    }
}
```

## How to Verify the Webhook
To verify the webhook, use the `@pimlico/webhook` package. You will need the webhook secret, which can be found in the sponsorship policy [settings](https://dashboard.pimlico.io/sponsorship-policies).

### Installation

```bash
pnpm install @pimlico/webhook
```

### Usage

```typescript
import { pimlicoWebhookVerifier } from "@pimlico/webhook";
import type { VercelRequest, VercelResponse } from "@vercel/node";

const webhookSecret = process.env.PIMLICO_WEBHOOK_SECRET as string;
const verifyWebhook = pimlicoWebhookVerifier(webhookSecret);

export default async function handler(req: VercelRequest, res: VercelResponse) {
    try {
        const webhookEvent = verifyWebhook(
            req.headers as Record<string, string>,
            JSON.stringify(req.body)
        );

        switch (webhookEvent.type) {
            case "user_operation.sponsorship.requested":
            case "magic_spend.sponsorship.requested":
                return res.status(200).json({ sponsor: true });

            case "user_operation.sponsorship.finalized":
            case "magic_spend.sponsorship.finalized":
                return res.status(200).end();

            default:
                return res.status(400).json({ error: "Unknown webhook type" });
        }
    } catch (error) {
        return res.status(400).json({ error: "Invalid webhook signature" });
    }
}
```

## Testing Webhooks
Before deploying webhooks in production, test them using services like Beeceptor and Request Inspector. These tools help you debug webhook requests and responses in real time.

| Service         | Features                                      | URL |
|---------------|----------------------------------|---------------------------------|
| **Beeceptor** | Inspect, test, and debug webhooks | [beeceptor.com](https://beeceptor.com/) |
| **Request Inspector** | Capture and analyze HTTP requests | [requestinspector.com](https://requestinspector.com/) |

Using these tools, you can validate webhook payloads, check response structures, and ensure everything functions correctly before live deployment.
